# =============================================================================
# DEFAULT IMAGE
# =============================================================================

image: docker:19.03.1

# =============================================================================
# SERVICES
# =============================================================================

services:
  - docker:19.03.1-dind

# =============================================================================
# STAGES
# =============================================================================

stages: [ review, reports, build, scanning, deploy, merge ]

# =============================================================================
# GLOBAL VARIABLES
# =============================================================================

variables:

  DOCKER_HOST: tcp://localhost:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1

  GIT_DEPTH: 1
  GIT_SUBMODULE_STRATEGY: none

# =============================================================================
# INCLUDE ALL TEMPLATES
# =============================================================================

include:

  # Env: Config
  - local: "pipeline/config/.gitlab-ci-base.yml"
  - local: "pipeline/config/.gitlab-ci-lint.yml"

  # Env: Master
  - local: "pipeline/master/.gitlab-ci-audit.yml"
  - local: "pipeline/master/.gitlab-ci-code-quality.yml"
  - local: "pipeline/master/.gitlab-ci-build.yml"
  - local: "pipeline/master/.gitlab-ci-scanning.yml"
  - local: "pipeline/master/.gitlab-ci-deploy.yml"

  # Env: Stage
  - local: "pipeline/stage/.gitlab-ci-audit.yml"
  - local: "pipeline/stage/.gitlab-ci-code-quality.yml"
  - local: "pipeline/stage/.gitlab-ci-build.yml"
  - local: "pipeline/stage/.gitlab-ci-scanning.yml"
  - local: "pipeline/stage/.gitlab-ci-deploy.yml"

  # Env: Develop
  - local: "pipeline/develop/.gitlab-ci-audit.yml"
  - local: "pipeline/develop/.gitlab-ci-code-quality.yml"
  - local: "pipeline/develop/.gitlab-ci-build.yml"
  - local: "pipeline/develop/.gitlab-ci-scanning.yml"
  - local: "pipeline/develop/.gitlab-ci-deploy.yml"

  # Env: Merge
  - local: ".gitlab/ci/merge/.gitlab-ci-audit.yml"
  - local: "pipeline/merge/.gitlab-ci-code-quality.yml"
